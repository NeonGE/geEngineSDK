version: 2.1
orbs:
  coveralls: coveralls/coveralls@2.2.5
jobs:
  test_linux:
    docker:
      - image: cimg/base:current-22.04
    environment:
      CMAKE_BUILD_PARALLEL_LEVEL: 4
      CTEST_OUTPUT_ON_FAILURE: 1
    steps:
      - checkout

      - run:
          name: Install build tools
          command: |
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends \
              cmake ninja-build build-essential git \
              libicu-dev

      - run:
          name: Configure
          command: |
            cmake -S . -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=RelWithDebInfo \
              -DBUILD_TESTING=ON

      - run:
          name: Build
          command: |
            cmake --build build

      - run:
          name: Run tests (CTest -> JUnit)
          command: |
            mkdir -p build/test-results
            ctest --test-dir build --output-junit build/test-results/ctest.xml

      - store_test_results:
          path: build/test-results

      - store_artifacts:
          path: build/test-results
          destination: test-results

  coverage_linux:
    docker:
      - image: cimg/base:current-22.04
    environment:
      CMAKE_BUILD_PARALLEL_LEVEL: 4
      CTEST_OUTPUT_ON_FAILURE: 1
    steps:
      - checkout

      - run:
          name: Install build tools (with lcov)
          command: |
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends \
              cmake ninja-build build-essential git \
              libicu-dev lcov

      - run:
          name: Configure (coverage)
          command: |
            cmake -S . -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=Debug \
              -DBUILD_TESTING=ON \
              -DCMAKE_C_FLAGS="--coverage -O0 -g" \
              -DCMAKE_CXX_FLAGS="--coverage -O0 -g" \
              -DCMAKE_EXE_LINKER_FLAGS="--coverage"

      - run:
          name: Build
          command: |
            cmake --build build

      - run:
          name: Run tests
          command: |
            ctest --test-dir build --output-on-failure

      - run:
          name: Generate lcov report
          command: |
            lcov --capture --directory build --output-file coverage.info

            lcov --remove coverage.info \
              '/usr/*' \
              '*/_deps/*' \
              '*/tests/*' \
              '*/external/*' \
              '*/external/*' \
              --output-file coverage.info

            lcov --list coverage.info

      - coveralls/upload:
          path_to_lcov: coverage.info

      - store_artifacts:
          path: coverage.info
          destination: coverage

  test_windows:
    machine:
      image: windows-server-2022-gui:current
    resource_class: windows.medium
    shell: powershell.exe -ExecutionPolicy Bypass
    environment:
      CTEST_OUTPUT_ON_FAILURE: 1
    steps:
      - checkout

      - run:
          name: Install build tools (Chocolatey)
          command: |
            choco install -y cmake --installargs 'ADD_CMAKE_TO_PATH=System'
            choco install -y ninja

      - run:
          name: Configure (VS 2022)
          command: |
            cmake -S . -B build -G "Visual Studio 17 2022" -A x64 -DBUILD_TESTING=ON

      - run:
          name: Build
          command: |
            cmake --build build --config RelWithDebInfo

      - run:
          name: Run tests (CTest -> JUnit)
          command: |
            New-Item -ItemType Directory -Force build\test-results | Out-Null
            ctest --test-dir build -C RelWithDebInfo --output-junit build\test-results\ctest.xml

      - store_test_results:
          path: build/test-results

      - store_artifacts:
          path: build/test-results
          destination: test-results

workflows:
  tests:
    jobs:
      - test_linux
      - coverage_linux
      - test_windows
